version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    DOCKER_REGISTRY: "${REGISTRY_URL}"
    IMAGE_NAME: "${imageName}"
    BUILDRUN_HASH: "${OCI_BUILD_RUN_ID}"
    USER_NAME: ${userName}
steps:
  - type: Command
    name: "Install Docker"
    timeoutInSeconds: 300
    command: |
      echo "Installing Docker on Oracle Linux 7..."
      yum update -y
      yum install -y yum-utils device-mapper-persistent-data lvm2
      yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      yum install -y docker-ce docker-ce-cli containerd.io
      service docker start
      chkconfig docker on
      echo "Docker installation completed"

  - type: Command
    name: "Build Docker Image"
    timeoutInSeconds: 1800
    command: |
      echo "Building Docker image..."
      cd voice-pipeline-agent-python
      
      # Get tenancy namespace
      echo "Using tenancy namespace: ${tenancyName}"
      
      # Build images
      docker build -t ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${tenancyName}/${imageName}:${OCI_BUILD_RUN_ID} .

outputArtifacts:
  - name: livekit_agent_image
    type: DOCKER_IMAGE
    location: ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${tenancyName}/${imageName}:${BUILDRUN_HASH}
