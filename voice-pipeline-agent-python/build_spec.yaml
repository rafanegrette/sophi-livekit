version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    DOCKER_REGISTRY: "${REGISTRY_URL}"
    IMAGE_NAME: "${IMAGE_NAME}"
    BUILDRUN_HASH: "${OCI_BUILD_RUN_ID}"

steps:
  - type: Command
    name: "Install Docker"
    timeoutInSeconds: 300
    command: |
      echo "Installing Docker on Oracle Linux 7..."
      yum update -y
      yum install -y yum-utils device-mapper-persistent-data lvm2
      yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      yum install -y docker-ce docker-ce-cli containerd.io
      service docker start
      chkconfig docker on
      echo "Docker installation completed"

  - type: Command
    name: "Debug Environment Variables"
    timeoutInSeconds: 300
    command: |
      echo "=== Debugging Environment Variables ==="
      echo "OCI_RESOURCE_PRINCIPAL_REGION: ${OCI_RESOURCE_PRINCIPAL_REGION}"
      echo "TENANCY_NAMESPACE: ${TENANCY_NAMESPACE}"
      echo "IMAGE_NAME: ${IMAGE_NAME}"
      echo "OCI_BUILD_RUN_ID: ${OCI_BUILD_RUN_ID}"
      echo "BUILDRUN_HASH: ${BUILDRUN_HASH}"
      echo "All environment variables:"
      env | grep -E "(OCI_|TENANCY|IMAGE|BUILD)" | sort
      echo "=== End Debug ==="

  - type: Command
    name: "Build Docker Image"
    timeoutInSeconds: 1800
    command: |
      echo "Building Docker image..."
      cd voice-pipeline-agent-python
            # Check if required variables are set
      if [ -z "${TENANCY_NAMESPACE}" ]; then
        echo "ERROR: TENANCY_NAMESPACE is not set"
        exit 1
      fi
      
      if [ -z "${IMAGE_NAME}" ]; then
        echo "ERROR: IMAGE_NAME is not set"
        exit 1
      fi
      
      if [ -z "${OCI_BUILD_RUN_ID}" ]; then
        echo "ERROR: OCI_BUILD_RUN_ID is not set"
        exit 1
      fi
      # Convert IMAGE_NAME to lowercase to avoid Docker tag issues
      docker build -t ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${TENANCY_NAMESPACE}/${IMAGE_NAME}:${BUILDRUN_HASH} .
      docker build -t ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${TENANCY_NAMESPACE}/${IMAGE_NAME}:latest .

  - type: Command
    name: "Login to Container Registry"
    timeoutInSeconds: 300
    command: |
      echo "Logging into OCI Container Registry..."
      echo $OCI_RESOURCE_PRINCIPAL_REGION
      docker login ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io --username ${TENANCY_NAMESPACE}/oracleidentitycloudservice/${USER_NAME} --password-stdin <<< "${OCI_RESOURCE_PRINCIPAL_TOKEN}"

  - type: Command
    name: "Push Docker Image"
    timeoutInSeconds: 1800
    command: |
      echo "Pushing Docker image to registry..."
      docker push ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${TENANCY_NAMESPACE}/${IMAGE_NAME}:${BUILDRUN_HASH}
      docker push ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${TENANCY_NAMESPACE}/${IMAGE_NAME}:latest

outputArtifacts:
  - name: livekit_agent_image
    type: DOCKER_IMAGE
    location: ${OCI_RESOURCE_PRINCIPAL_REGION}.ocir.io/${TENANCY_NAMESPACE}/${IMAGE_NAME}:${BUILDRUN_HASH}
